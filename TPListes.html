<!DOCTYPE html>
<html lang="en" xmlns:css="http://www.w3.org/1999/xhtml" xmlns:style="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Test Liste</title>
    <link rel="stylesheet" type="text/css" href="TPliste.css">
</head>

<body>
<style>.highlight {text-decoration-color: #fff168} </style>

<div class="login" >
Login : <input id="Login"type="text">
Password: <input id="Password" type="text">
</div>


<div id="result">
</div>

<div class="divlist">
    <div class="listtitle">List to create
        <input type='texte' name='listName'>
    </div>
    <button name='addList'>Add a list</button>
</div>

<script src="./jquery-3.3.1.js" type="text/javascript"></script>

<script>
    function displayLists() {
        /* clean the place */
        $("#result").empty();

        /* get the todo lists in data from ajax server call */
        $.ajax( {
            url: "http://92.222.69.104:80/todo/listes",
            headers: {"login": "MICHAUD", "password": "Eric"}
            }).done(function (data) {

            /* add a first empty list */
            $("div#result").append("<ul class='result'></ul>");
            console.log(data);

            /* add en list for each element of data */
            var indexList=0;
            data.todoListes.forEach(
                function (list) {
                    if (list.name !== null) {
                        $("ul.result:last-child").append(
                            "<div class='divlist'>" +
                                "<li id='list_"+indexList+"'>" +
                                    "<div class='listtitle'>"+list.name +
                                        "<button class='buttonDelList' index='" + indexList + "'>" +
                                            "<img src='cancelcross.png' alt='cancel cross'>" +
                                        "</button>" +
                                    "</div>"+
                                "</li>" +
                            "</div>");


                        /* add a list of items in any case even if empty */
                        $("li#list_"+indexList+":last-child").append("<ul class='items list_" + indexList + "'></ul>");
                        if (list.elements.length != 0) {
                            var indexItem=0;
                            list.elements.forEach(
                                function (item) {
                                    $("ul.list_" + indexList + ":last-child").append(
                                        "<li class='item'>" + item +
                                            "<button class='buttonDelItem' listname='list_" + indexList + "' index='"+indexItem+"'>"+
                                                "<img src='cancelcross.png' alt='cancel cross'>" +
                                            "</button>"+
                                        "</li>");
                                    indexItem+=1;
                                });

                            }
                        /* add a text input to create item */
                        $("ul.list_" + indexList+ ":last-child").append(   "<input type='texte' name='list_"+indexList+"'>" +
                                                            "<button class='buttonAddItem' name='list_"+indexList+"'> add </button>");

                        indexList+=1;
                    }
                });

            /* Create an action on create liste button */
            $("button[name=addList]").on("click",function(){
                var listName=$("input[name=listName]").val();
                console.log(listName);
                createNewList(listName);
            });

            /* Create an action on each delete List button */
            $("button.buttonDelList").on("click", function () {
                /* console.log("ok for delete :" + $(this).attr('index'));*/
                deleteList($(this).attr('index'));
             });

            /* Create an action on each add item  button */
            $("button.buttonAddItem").on("click", function () {
                var listIndex=Number($(this).attr('name').replace(/list_/gi,""));
                var item = $("input[name='list_"+listIndex+"']").val();
                console.log("ok to add "+ item +" to: list_" + listIndex);
                createnewItem(listIndex,item);
            });

            /* Create an action on each delete item  button */
            $("button.buttonDelItem").on("click", function () {
                var listIndex = Number($(this).attr('listname').replace(/list_/gi,""));
                var itemIndex = $(this).attr('index');
                console.log("ok to delete item:"+ itemIndex +" of:list_" + listIndex);
                deleteItem(listIndex, itemIndex);
            });


        });


    }

/*    JSON.stringify([{"nom" :"TOTO1","prenom":"TATA"},
        {"nom" : "TOTO2", "prenom":"TATA"}]),*/

    function createNewList(nom) {
        if (nom!==null) {
            $.ajax({
                url: "http://92.222.69.104:80/todo/listes",
                headers: {"login": "MICHAUD", "password": "Eric"}
            }).done(
                function (data) {
                    console.log(data);
                    newlist = {name: nom, elements: []};
                    data.todoListes.push(newlist);
                    console.log(data);

                    $.ajax({
                        type: 'post',
                        url: "http://92.222.69.104:80/todo/listes",
                        data: JSON.stringify(data),
                        contentType: "application/json; charset=utf-8"
                    }).done(function (data) {
                        console.log(data)
                    });
                });
            displayLists();
            }
        };


    function deleteList(listIndex) {
        if (listIndex!==null) {
            /*Call service 1 to get object list */
            $.ajax({
                url: "http://92.222.69.104:80/todo/listes",
                headers: {"login": "MICHAUD", "password": "Eric"}
            }).done( function (data) {
                    data.todoListes.splice(listIndex,1);

                    $.ajax({
                        type: 'post',
                        url: "http://92.222.69.104:80/todo/listes",
                        data: JSON.stringify(data),
                        contentType: "application/json; charset=utf-8"
                        }).done(function (data) {
                            /* console.log(data)*/
                        });
                    });
            }
        };



    function createnewItem(listIndex,item) {
        $.ajax({
            url: "http://92.222.69.104:80/todo/listes",
            headers: {"login": "MICHAUD", "password": "Eric"}
            }).done(
                function (data) {
                    console.log(data);
                    data.todoListes[listIndex].elements.push(item);
                    console.log(data);

                $.ajax({
                    type: 'post',
                    url: "http://92.222.69.104:80/todo/listes",
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8"
                    }).done(function (data) {
                        console.log(data)
                        });
                });
        };


    function deleteItem(listIndex,itemIndex) {
        if (listIndex!==null && itemIndex!==null) {
            /*Call service 1 to get object list */
            $.ajax({
                url: "http://92.222.69.104:80/todo/listes",
                headers: {"login": "MICHAUD", "password": "Eric"}
                }).done( function (data) {
                        console.log(data);
                        data.todoListes[listIndex].elements.splice(itemIndex,1);
                        console.log(data);


                    $.ajax({
                            type: 'post',
                            url: "http://92.222.69.104:80/todo/listes",
                            data: JSON.stringify(data),
                            contentType: "application/json; charset=utf-8"
                            }).done(function (data) {
                                console.log(data)
                                });
                    });
            }
        };





    $(document).ready(function() {
        /*alert("Le document est charg√©");*/
        displayLists("MICHAUD","Eric");
    });




</script>

</body>
</html>